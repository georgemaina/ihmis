/*
 * File: app/view/CashSales.js
 *
 * This file was generated by Sencha Architect version 4.3.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 7.6.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 7.6.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('CarePortal.view.CashSales', {
    extend: 'Ext.form.Panel',
    alias: 'widget.cashsales',

    requires: [
        'CarePortal.view.CashSalesViewModel',
        'CarePortal.view.PendingBills',
        'Ext.grid.Panel',
        'Ext.form.FieldSet',
        'Ext.form.RadioGroup',
        'Ext.form.field.Radio',
        'Ext.form.field.ComboBox',
        'Ext.form.field.Date',
        'Ext.view.Table',
        'Ext.selection.RowModel',
        'Ext.grid.plugin.CellEditing',
        'Ext.form.field.Number',
        'Ext.grid.column.Action',
        'Ext.button.Button'
    ],

    viewModel: {
        type: 'cashsales'
    },
    height: 800,
    itemId: 'cashSales',
    style: 'background-color: #d9f2e6;',
    layout: 'auto',
    bodyPadding: '1 0 0 4',
    bodyStyle: 'background-color: #d9f2e6;',
    url: 'data/getDataFunctions.php?task=saveCashSales',
    defaultListenerScope: true,

    items: [
        {
            xtype: 'container',
            flex: 1,
            height: 800,
            layout: {
                type: 'hbox',
                align: 'stretch'
            },
            items: [
                {
                    xtype: 'pendingbills',
                    height: 700,
                    itemId: 'pendingBills',
                    width: 372,
                    collapseDirection: 'left',
                    collapsible: true,
                    flex: 0
                },
                {
                    xtype: 'container',
                    flex: 1,
                    height: 800,
                    layout: {
                        type: 'vbox',
                        align: 'stretch'
                    },
                    items: [
                        {
                            xtype: 'fieldset',
                            style: 'background-color: #d9f2e6;',
                            layout: {
                                type: 'hbox',
                                align: 'stretch'
                            },
                            items: [
                                {
                                    xtype: 'radiogroup',
                                    itemId: 'salesType',
                                    padding: 0,
                                    fieldLabel: 'Sales Type',
                                    labelStyle: 'color:green; font-weight:bold;',
                                    layout: {
                                        type: 'vbox',
                                        align: 'stretch'
                                    },
                                    items: [
                                        {
                                            xtype: 'radiofield',
                                            itemId: 'bill',
                                            name: 'salesType',
                                            boxLabel: '<b>Patient Bill</b>',
                                            checked: true,
                                            inputValue: 'bill'
                                        },
                                        {
                                            xtype: 'radiofield',
                                            itemId: 'cashSale',
                                            labelWidth: 140,
                                            name: 'salesType',
                                            boxLabel: '<b>Cash Sale / Walk IN</>',
                                            inputValue: 'cashSale'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'textfield',
                                    itemId: 'CashPoint',
                                    width: 205,
                                    fieldLabel: 'Cash Point',
                                    labelAlign: 'top',
                                    labelStyle: 'color:green; font-weight:bold;',
                                    labelWidth: 80,
                                    name: 'cashPoint',
                                    fieldStyle: 'color:red; font-weight:bold;',
                                    allowBlank: false,
                                    emptyText: 'Cash Point'
                                },
                                {
                                    xtype: 'textfield',
                                    itemId: 'ShiftNo',
                                    width: 205,
                                    fieldLabel: 'Shift No',
                                    labelAlign: 'top',
                                    labelStyle: 'color:green; font-weight:bold;',
                                    labelWidth: 80,
                                    name: 'shiftNo',
                                    fieldStyle: 'color:red; font-weight:bold;',
                                    allowBlank: false,
                                    emptyText: 'Shift No'
                                },
                                {
                                    xtype: 'textfield',
                                    itemId: 'ReceiptNo',
                                    fieldLabel: 'Receipt No',
                                    labelAlign: 'top',
                                    labelStyle: 'color:green; font-weight:bold;',
                                    name: 'receiptNo',
                                    fieldStyle: 'color:red; font-weight:bold;',
                                    emptyText: 'Receipt Number'
                                }
                            ]
                        },
                        {
                            xtype: 'fieldcontainer',
                            height: 36,
                            padding: 0,
                            layout: 'absolute',
                            items: [
                                {
                                    xtype: 'combobox',
                                    x: -91,
                                    itemId: 'PayMode',
                                    padding: 0,
                                    width: 270,
                                    fieldLabel: 'Payment Mode',
                                    labelAlign: 'right',
                                    labelStyle: 'color:green; font-weight:bold;',
                                    labelWidth: 110,
                                    name: 'payMode',
                                    fieldStyle: 'color:red; font-weight:bold;',
                                    allowBlank: false,
                                    emptyText: 'Payment Mode',
                                    displayField: 'Description',
                                    minChars: 2,
                                    queryMode: 'local',
                                    store: [
                                        'Cash',
                                        'Mpesa',
                                        'Cheque',
                                        'Both',
                                        'Visa'
                                    ],
                                    typeAhead: true,
                                    valueField: 'ID'
                                },
                                {
                                    xtype: 'textfield',
                                    x: 425,
                                    itemId: 'glAccount',
                                    width: 270,
                                    fieldLabel: 'GL Account',
                                    labelAlign: 'right',
                                    labelStyle: 'color:green; font-weight:bold;',
                                    name: 'glAccount',
                                    value: 1020,
                                    fieldStyle: 'color:red; font-weight:bold;',
                                    emptyText: 'GL Account'
                                },
                                {
                                    xtype: 'datefield',
                                    x: 690,
                                    itemId: 'CurrDate',
                                    fieldLabel: 'Date',
                                    labelAlign: 'right',
                                    labelStyle: 'color:green; font-weight:bold;',
                                    name: 'currDate',
                                    fieldStyle: 'color:red; font-weight:bold;',
                                    allowBlank: false,
                                    emptyText: 'Date',
                                    format: 'Y/m/d'
                                }
                            ]
                        },
                        {
                            xtype: 'fieldset',
                            height: 38,
                            itemId: 'patientDetails',
                            padding: 0,
                            style: 'background-color: #d9f2e6;',
                            layout: 'absolute',
                            items: [
                                {
                                    xtype: 'textfield',
                                    x: 25,
                                    itemId: 'Pid',
                                    fieldLabel: 'Pid',
                                    labelAlign: 'right',
                                    labelStyle: 'color:green; font-weight:bold;',
                                    name: 'pid',
                                    fieldStyle: 'color:red; font-weight:bold;',
                                    inputType: 'number',
                                    allowBlank: false,
                                    allowOnlyWhitespace: false,
                                    autoHideInputMask: false
                                },
                                {
                                    xtype: 'textfield',
                                    x: 295,
                                    itemId: 'Names',
                                    width: 215,
                                    hideLabel: true,
                                    labelWidth: 0,
                                    name: 'patient',
                                    fieldStyle: 'color:red; font-weight:bold;',
                                    emptyText: 'Patient Names'
                                },
                                {
                                    xtype: 'textfield',
                                    x: 530,
                                    y: 0,
                                    itemId: 'encNr',
                                    fieldLabel: 'Encounter No',
                                    labelAlign: 'right',
                                    labelStyle: 'color:green; font-weight:bold;',
                                    name: 'encNr',
                                    fieldStyle: 'color:red; font-weight:bold;'
                                },
                                {
                                    xtype: 'textfield',
                                    x: 795,
                                    y: 0,
                                    itemId: 'BillNumber',
                                    fieldLabel: 'Bill Number',
                                    labelAlign: 'right',
                                    labelStyle: 'color:green; font-weight:bold;',
                                    name: 'billNumber',
                                    fieldStyle: 'color:red; font-weight:bold;'
                                }
                            ]
                        },
                        {
                            xtype: 'fieldset',
                            height: 36,
                            itemId: 'patientDetails1',
                            padding: 0,
                            style: 'background-color: #d9f2e6;',
                            layout: 'absolute',
                            items: [
                                {
                                    xtype: 'textfield',
                                    x: -24,
                                    flex: 1,
                                    itemId: 'Payer',
                                    width: 460,
                                    fieldLabel: 'Payer',
                                    labelAlign: 'right',
                                    labelStyle: 'color:green; font-weight:bold;',
                                    labelWidth: 150,
                                    name: 'payer',
                                    fieldStyle: 'color:red; font-weight:bold;',
                                    emptyText: 'Enter person paying if not patient'
                                },
                                {
                                    xtype: 'combobox',
                                    x: 765,
                                    y: 0,
                                    itemId: 'deptName',
                                    fieldLabel: 'Department',
                                    labelAlign: 'right',
                                    labelStyle: 'color:green; font-weight:bold;',
                                    labelWidth: 130,
                                    name: 'department',
                                    fieldStyle: 'color:red; font-weight:bold;',
                                    emptyText: 'Department',
                                    displayField: 'Description',
                                    minChars: 2,
                                    store: 'DepartmentsStore',
                                    typeAhead: true,
                                    valueField: 'Nr'
                                }
                            ]
                        },
                        {
                            xtype: 'gridpanel',
                            height: 250,
                            itemId: 'itemsGrid',
                            resizable: false,
                            scrollable: 'both',
                            columnLines: true,
                            store: 'CashSaleStore',
                            selModel: {
                                selType: 'rowmodel'
                            },
                            plugins: [
                                {
                                    ptype: 'cellediting',
                                    clicksToEdit: 1
                                }
                            ],
                            columns: [
                                {
                                    xtype: 'gridcolumn',
                                    hidden: true,
                                    dataIndex: 'ID',
                                    text: 'ID'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    hidden: true,
                                    dataIndex: 'CatID',
                                    text: 'CatID'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    hidden: true,
                                    dataIndex: 'Names',
                                    text: 'Category'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    dataIndex: 'PartCode',
                                    text: 'PartCode'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    width: 299,
                                    dataIndex: 'Description',
                                    text: 'Description'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    dataIndex: 'Price',
                                    text: 'Amount',
                                    editor: {
                                        xtype: 'textfield'
                                    }
                                },
                                {
                                    xtype: 'gridcolumn',
                                    dataIndex: 'qty',
                                    text: 'Qty',
                                    editor: {
                                        xtype: 'numberfield',
                                        minValue: 0
                                    }
                                },
                                {
                                    xtype: 'gridcolumn',
                                    renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                        var strSum=0;
                                        var totalPrice=record.get('Price')*record.get('qty');
                                        var totals=Math.ceil(totalPrice / 10) * 10;
                                        store.getRange().forEach(function(rec) {
                                            // console.log(rec.get('unit_price'));
                                            totalAmount=rec.get('Price')*rec.get('qty');
                                            strSum += Math.ceil(totalAmount / 10) * 10;
                                            console.log(rec.get('strSum'));
                                        });

                                        view.up('grid').up('panel').down('#total').setValue(strSum);


                                        return Math.round(totals);
                                    },
                                    dataIndex: 'Total',
                                    text: 'Total',
                                    editor: {
                                        xtype: 'textfield'
                                    }
                                },
                                {
                                    xtype: 'gridcolumn',
                                    dataIndex: 'BillDate',
                                    text: 'Bill Date'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    dataIndex: 'BillTime',
                                    text: 'Bill Time'
                                },
                                {
                                    xtype: 'actioncolumn',
                                    onConfirm: function(choice) {

                                    },
                                    align: 'center',
                                    text: 'Remove',
                                    iconCls: 'icons/delete1.jpg',
                                    items: [
                                        {
                                            handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                                Ext.MessageBox.confirm('Confirm', 'Are you sure you want to remove '+record.get('Description')+"?", function() {
                                                    // process text value and close...
                                                    view.getStore().remove(record);

                                                    Ext.Ajax.request({
                                                        url: 'data/getDataFunctions.php?task=deleteCashItem',
                                                        params: {
                                                            ID:record.get("ID"),
                                                            tableName:'care_ke_billing',
                                                            idColumn:'ID',
                                                            batch_nr:record.get("ID")
                                                        },
                                                        success: function(response){
                                                            var resp = Ext.JSON.decode(response.responseText);
                                                            // Ext.Msg.alert("Success","Successfully Removed "+record.get('Description'));

                                                            //this.getNotes(encounterNo);

                                                        },
                                                        failure: function (form, action) {
                                                            var jsonResp = Ext.decode(action.response.responseText);

                                                            Ext.Msg.alert('Failed', 'There was a problem with the Request. \n Error=' + jsonResp.error);
                                                        },
                                                        scope:this
                                                    });

                                                });


                                            },
                                            icon: 'icons/delete1.jpg'
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            xtype: 'container',
                            flex: 1,
                            items: [
                                {
                                    xtype: 'fieldset',
                                    height: 36,
                                    margin: 0,
                                    padding: 0,
                                    style: 'background-color: #d9f2e6;',
                                    layout: 'absolute',
                                    items: [
                                        {
                                            xtype: 'button',
                                            x: 5,
                                            y: 0,
                                            itemId: 'cmdGetCashItems',
                                            width: 145,
                                            iconCls: 'x-fa fa-download',
                                            text: 'Get Products List'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'fieldset',
                                    height: 205,
                                    padding: 0,
                                    style: 'background-color: #d9f2e6;',
                                    layout: 'absolute',
                                    items: [
                                        {
                                            xtype: 'button',
                                            x: 635,
                                            y: 110,
                                            itemId: 'cmdSaveSales',
                                            width: 120,
                                            iconCls: 'x-fa fa-save',
                                            text: '<b>Save</b>'
                                        },
                                        {
                                            xtype: 'button',
                                            x: 815,
                                            y: 110,
                                            width: 95,
                                            iconCls: 'x-fa fa-close',
                                            text: '<b>Close</b>'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 375,
                                            y: -1,
                                            itemId: 'total',
                                            width: 225,
                                            fieldLabel: 'Total',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            name: 'totalCost'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 375,
                                            y: 140,
                                            itemId: 'balance',
                                            width: 225,
                                            fieldLabel: 'Balance',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            name: 'balance'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 375,
                                            y: 105,
                                            itemId: 'visa',
                                            width: 225,
                                            fieldLabel: 'Visa',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            name: 'visa'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 355,
                                            y: 70,
                                            itemId: 'mpesa',
                                            width: 245,
                                            fieldLabel: 'Received Mpesa',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            labelWidth: 120,
                                            name: 'mpesa',
                                            listeners: {
                                                change: 'onMpesaChange'
                                            }
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 555,
                                            y: 70,
                                            itemId: 'mpesa1',
                                            width: 260,
                                            fieldLabel: 'Mpesa Ref',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            labelWidth: 120,
                                            name: 'mpesaRef'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 375,
                                            y: 35,
                                            itemId: 'cash',
                                            width: 225,
                                            fieldLabel: 'Received Cash',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            name: 'cash',
                                            listeners: {
                                                change: 'onCashChange'
                                            }
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    ],

    onMpesaChange: function(field, newValue, oldValue, eOpts) {
        var total=field.up('form').down('#total').getValue();
        var cash=field.up('form').down('#cash').getValue();
        if(cash>0){
            var bal=parseInt(newValue)+parseInt(cash)-parseInt(total);
        }else{
            var bal=newValue-total;
        }

        field.up('form').down('#balance').setValue(bal);
    },

    onCashChange: function(field, newValue, oldValue, eOpts) {
        var total=field.up('form').down('#total').getValue();
        var bal=newValue-total;
        field.up('form').down('#balance').setValue(bal);

    }

});