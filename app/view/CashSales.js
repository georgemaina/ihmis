/*
 * File: app/view/CashSales.js
 *
 * This file was generated by Sencha Architect version 4.2.4.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('CarePortal.view.CashSales', {
    extend: 'Ext.form.Panel',
    alias: 'widget.cashsales',

    requires: [
        'CarePortal.view.CashSalesViewModel',
        'CarePortal.view.PendingBills',
        'Ext.grid.Panel',
        'Ext.form.FieldSet',
        'Ext.form.RadioGroup',
        'Ext.form.field.Radio',
        'Ext.form.field.ComboBox',
        'Ext.form.field.Date',
        'Ext.view.Table',
        'Ext.selection.RowModel',
        'Ext.grid.plugin.CellEditing',
        'Ext.grid.column.Column',
        'Ext.form.field.Number',
        'Ext.button.Button'
    ],

    viewModel: {
        type: 'cashsales'
    },
    height: 651,
    itemId: 'cashSales',
    style: 'background-color: #d9f2e6;',
    layout: 'auto',
    bodyPadding: '1 0 0 4',
    bodyStyle: 'background-color: #d9f2e6;',
    url: 'data/getDataFunctions.php?task=saveCashSales',
    defaultListenerScope: true,

    items: [
        {
            xtype: 'container',
            layout: {
                type: 'hbox',
                align: 'stretch'
            },
            items: [
                {
                    xtype: 'pendingbills',
                    itemId: 'pendingBills',
                    width: 372,
                    collapseDirection: 'left',
                    collapsible: true,
                    flex: 0
                },
                {
                    xtype: 'container',
                    flex: 1,
                    items: [
                        {
                            xtype: 'container',
                            items: [
                                {
                                    xtype: 'fieldset',
                                    style: 'background-color: #d9f2e6;',
                                    layout: {
                                        type: 'hbox',
                                        align: 'stretch'
                                    },
                                    items: [
                                        {
                                            xtype: 'radiogroup',
                                            flex: 1,
                                            itemId: 'salesType',
                                            padding: 0,
                                            fieldLabel: 'Sales Type',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            labelWidth: 80,
                                            items: [
                                                {
                                                    xtype: 'radiofield',
                                                    itemId: 'bill',
                                                    name: 'salesType',
                                                    boxLabel: '<b>Patient Bill</b>',
                                                    checked: true,
                                                    inputValue: 'bill'
                                                },
                                                {
                                                    xtype: 'radiofield',
                                                    itemId: 'cashSale',
                                                    labelWidth: 140,
                                                    name: 'salesType',
                                                    boxLabel: '<b>Cash Sale / Walk IN</>',
                                                    inputValue: 'cashSale'
                                                }
                                            ]
                                        },
                                        {
                                            xtype: 'textfield',
                                            itemId: 'CashPoint',
                                            width: 205,
                                            fieldLabel: 'Cash Point',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            labelWidth: 80,
                                            name: 'cashPoint',
                                            fieldStyle: 'color:red; font-weight:bold;',
                                            allowBlank: false,
                                            emptyText: 'Cash Point'
                                        },
                                        {
                                            xtype: 'textfield',
                                            itemId: 'ShiftNo',
                                            width: 205,
                                            fieldLabel: 'Shift No',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            labelWidth: 80,
                                            name: 'shiftNo',
                                            fieldStyle: 'color:red; font-weight:bold;',
                                            allowBlank: false,
                                            emptyText: 'Shift No'
                                        },
                                        {
                                            xtype: 'textfield',
                                            itemId: 'ReceiptNo',
                                            fieldLabel: 'Receipt No',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            name: 'receiptNo',
                                            fieldStyle: 'color:red; font-weight:bold;',
                                            emptyText: 'Receipt Number'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'fieldcontainer',
                                    padding: 0,
                                    layout: {
                                        type: 'hbox',
                                        align: 'stretch'
                                    },
                                    items: [
                                        {
                                            xtype: 'combobox',
                                            itemId: 'PayMode',
                                            padding: 0,
                                            width: 313,
                                            fieldLabel: 'Payment Mode',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            labelWidth: 110,
                                            name: 'payMode',
                                            fieldStyle: 'color:red; font-weight:bold;',
                                            allowBlank: false,
                                            emptyText: 'Payment Mode',
                                            displayField: 'Description',
                                            minChars: 2,
                                            queryMode: 'local',
                                            store: [
                                                'Cash',
                                                'Mpesa',
                                                'Both',
                                                'Visa'
                                            ],
                                            typeAhead: true,
                                            valueField: 'ID'
                                        },
                                        {
                                            xtype: 'textfield',
                                            flex: 1,
                                            itemId: 'glAccount',
                                            fieldLabel: 'GL Account',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            labelWidth: 275,
                                            name: 'glAccount',
                                            value: 1020,
                                            fieldStyle: 'color:red; font-weight:bold;',
                                            emptyText: 'GL Account'
                                        },
                                        {
                                            xtype: 'datefield',
                                            flex: 1,
                                            itemId: 'CurrDate',
                                            fieldLabel: 'Date',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            name: 'currDate',
                                            fieldStyle: 'color:red; font-weight:bold;',
                                            allowBlank: false,
                                            emptyText: 'Date',
                                            format: 'Y/m/d'
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            xtype: 'container',
                            items: [
                                {
                                    xtype: 'fieldset',
                                    height: 82,
                                    itemId: 'patientDetails',
                                    padding: 0,
                                    style: 'background-color: #d9f2e6;',
                                    layout: 'absolute',
                                    items: [
                                        {
                                            xtype: 'textfield',
                                            x: 460,
                                            y: 40,
                                            itemId: 'BillNumber',
                                            width: 305,
                                            fieldLabel: 'Bill No',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            labelWidth: 130,
                                            name: 'billNumber',
                                            value: 0,
                                            fieldStyle: 'color:red; font-weight:bold;',
                                            emptyText: 'Generated Bill Number'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 460,
                                            y: 5,
                                            itemId: 'orderNo4',
                                            fieldLabel: 'Order Number',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            labelWidth: 130,
                                            name: 'orderNo',
                                            value: 0,
                                            fieldStyle: 'color:red; font-weight:bold;',
                                            emptyText: 'Order Number'
                                        },
                                        {
                                            xtype: 'combobox',
                                            x: 730,
                                            y: 5,
                                            itemId: 'deptName',
                                            fieldLabel: 'Department',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            labelWidth: 130,
                                            name: 'department',
                                            fieldStyle: 'color:red; font-weight:bold;',
                                            emptyText: 'Department',
                                            displayField: 'Description',
                                            minChars: 2,
                                            store: 'DepartmentsStore',
                                            typeAhead: true,
                                            valueField: 'Nr'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 220,
                                            y: 5,
                                            itemId: 'Names',
                                            width: 230,
                                            labelAlign: 'right',
                                            labelWidth: 130,
                                            name: 'patientName',
                                            fieldStyle: 'color:red; font-weight:bold;',
                                            emptyText: 'Patient Name'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: -40,
                                            y: 5,
                                            itemId: 'Pid',
                                            width: 260,
                                            fieldLabel: 'Patient',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            labelWidth: 150,
                                            name: 'pid',
                                            fieldStyle: 'color:red; font-weight:bold;',
                                            emptyText: 'Pid'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: -39,
                                            y: 40,
                                            itemId: 'Payer',
                                            width: 490,
                                            fieldLabel: 'Payer',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            labelWidth: 150,
                                            name: 'payer',
                                            fieldStyle: 'color:red; font-weight:bold;',
                                            emptyText: 'Enter person paying if not patient'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'gridpanel',
                                    height: 156,
                                    itemId: 'itemsGrid',
                                    resizable: true,
                                    columnLines: true,
                                    store: 'CashSaleStore',
                                    selModel: {
                                        selType: 'rowmodel'
                                    },
                                    plugins: [
                                        {
                                            ptype: 'cellediting',
                                            clicksToEdit: 1
                                        }
                                    ],
                                    columns: [
                                        {
                                            xtype: 'gridcolumn',
                                            hidden: true,
                                            dataIndex: 'CatID',
                                            text: 'CatID'
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            hidden: true,
                                            dataIndex: 'Names',
                                            text: 'Category'
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            dataIndex: 'PartCode',
                                            text: 'PartCode'
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            width: 299,
                                            dataIndex: 'Description',
                                            text: 'Description'
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            dataIndex: 'Price',
                                            text: 'Amount',
                                            editor: {
                                                xtype: 'textfield'
                                            }
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            dataIndex: 'qty',
                                            text: 'Qty',
                                            editor: {
                                                xtype: 'numberfield',
                                                minValue: 0
                                            }
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                                var strSum=0;
                                                store.getRange().forEach(function(rec) {
                                                    // console.log(rec.get('unit_price'));
                                                    strSum += (rec.get('Price')*rec.get('qty'));
                                                    console.log(rec.get('strSum'));
                                                } );
                                                view.up('grid').up('panel').down('#total').setValue(strSum);

                                                var totalPrice=record.get('Price')*record.get('qty');

                                                return totalPrice;
                                            },
                                            dataIndex: 'Total',
                                            text: 'Total',
                                            editor: {
                                                xtype: 'textfield'
                                            }
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            dataIndex: 'BillDate',
                                            text: 'Bill Date'
                                        },
                                        {
                                            xtype: 'gridcolumn',
                                            dataIndex: 'ID',
                                            text: 'Bill Time'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'fieldset',
                                    height: 36,
                                    margin: 0,
                                    padding: 0,
                                    style: 'background-color: #d9f2e6;',
                                    layout: 'absolute',
                                    items: [
                                        {
                                            xtype: 'button',
                                            x: 5,
                                            y: 0,
                                            itemId: 'cmdGetCashItems',
                                            width: 145,
                                            iconCls: 'x-fa fa-ellipsis-h',
                                            text: 'Get Products List'
                                        },
                                        {
                                            xtype: 'button',
                                            x: 175,
                                            y: 0,
                                            itemId: 'deleteSelectedItem',
                                            width: 150,
                                            iconCls: 'x-fa fa-trash',
                                            text: 'Remove Item'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'fieldset',
                                    height: 233,
                                    padding: 0,
                                    style: 'background-color: #d9f2e6;',
                                    layout: 'absolute',
                                    items: [
                                        {
                                            xtype: 'button',
                                            x: 675,
                                            y: 175,
                                            itemId: 'cmdSaveSales',
                                            width: 120,
                                            iconCls: 'x-fa fa-save',
                                            text: 'Save'
                                        },
                                        {
                                            xtype: 'button',
                                            x: 840,
                                            y: 175,
                                            width: 95,
                                            iconCls: 'x-fa fa-close',
                                            text: 'Close'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 375,
                                            y: -1,
                                            itemId: 'total',
                                            width: 225,
                                            fieldLabel: 'Total',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            name: 'totalCost'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 375,
                                            y: 140,
                                            itemId: 'balance',
                                            width: 225,
                                            fieldLabel: 'Balance',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            name: 'balance'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 375,
                                            y: 105,
                                            itemId: 'visa',
                                            width: 225,
                                            fieldLabel: 'Visa',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            name: 'visa'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 355,
                                            y: 70,
                                            itemId: 'mpesa',
                                            width: 245,
                                            fieldLabel: 'Received Mpesa',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            labelWidth: 120,
                                            name: 'mpesa',
                                            listeners: {
                                                change: 'onMpesaChange'
                                            }
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 555,
                                            y: 70,
                                            itemId: 'mpesa1',
                                            width: 260,
                                            fieldLabel: 'Mpesa Ref',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            labelWidth: 120,
                                            name: 'mpesaRef'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 375,
                                            y: 35,
                                            itemId: 'cash',
                                            width: 225,
                                            fieldLabel: 'Received Cash',
                                            labelAlign: 'right',
                                            labelStyle: 'color:green; font-weight:bold;',
                                            name: 'cash',
                                            listeners: {
                                                change: 'onCashChange'
                                            }
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    ],

    onMpesaChange: function(field, newValue, oldValue, eOpts) {
        var total=field.up('form').down('#total').getValue();
        var cash=field.up('form').down('#cash').getValue();
        if(cash>0){
            var bal=parseInt(newValue)+parseInt(cash)-parseInt(total);
        }else{
            var bal=newValue-total;
        }

        field.up('form').down('#balance').setValue(bal);
    },

    onCashChange: function(field, newValue, oldValue, eOpts) {
        var total=field.up('form').down('#total').getValue();
        var bal=newValue-total;
        field.up('form').down('#balance').setValue(bal);

    }

});